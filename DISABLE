# Verificar se o script está sendo executado como Administrador
function Check-Administrator {
    if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
        Write-Error "Este script precisa ser executado como Administrador!"
        exit 1
    }
}

# Desativar Windows Defender via Registro
function Disable-WindowsDefenderRegistry {
    Write-Host "Desativando o Windows Defender no Registro..." -ForegroundColor Yellow
    $defenderRegPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"

    # Criar chave de registro se não existir
    if (-not (Test-Path $defenderRegPath)) {
        New-Item -Path $defenderRegPath -Force | Out-Null
    }

    # Definir as propriedades principais para desativar
    Set-ItemProperty -Path $defenderRegPath -Name "DisableAntiSpyware" -Value 1 -Force
    Set-ItemProperty -Path $defenderRegPath -Name "DisableAntiVirus" -Value 1 -Force

    # Desabilitar Proteção em tempo real
    $realTimePath = "$defenderRegPath\Real-Time Protection"
    if (-not (Test-Path $realTimePath)) {
        New-Item -Path $realTimePath -Force | Out-Null
    }
    Set-ItemProperty -Path $realTimePath -Name "DisableRealtimeMonitoring" -Value 1 -Force
    Set-ItemProperty -Path $realTimePath -Name "DisableBehaviorMonitoring" -Value 1 -Force
    Set-ItemProperty -Path $realTimePath -Name "DisableOnAccessProtection" -Value 1 -Force
    Set-ItemProperty -Path $realTimePath -Name "DisableScanOnRealtimeEnable" -Value 1 -Force
}

# Desabilitar Serviços do Windows Defender
function Disable-DefenderServices {
    Write-Host "Parando e desativando os serviços do Windows Defender..." -ForegroundColor Yellow
    try {
        Stop-Service -Name "WinDefend" -Force -ErrorAction Stop
        Set-Service -Name "WinDefend" -StartupType Disabled -ErrorAction Stop
    } catch {
        Write-Warning "Erro ao desativar o serviço WinDefend: $_"
    }
}

# Desabilitar tarefas agendadas do Windows Defender
function Disable-DefenderScheduledTasks {
    Write-Host "Desativando tarefas agendadas do Windows Defender..." -ForegroundColor Yellow
    $tasks = @(
        "Microsoft\Windows\Windows Defender\Windows Defender Scheduled Scan",
        "Microsoft\Windows\Windows Defender\Windows Defender Cache Maintenance",
        "Microsoft\Windows\Windows Defender\Windows Defender Cleanup",
        "Microsoft\Windows\Windows Defender\Windows Defender Verification"
    )

    foreach ($task in $tasks) {
        try {
            if (Get-ScheduledTask -TaskPath "\$($task.Substring(0, $task.LastIndexOf("\")))" -TaskName ($task.Split("\")[-1]) -ErrorAction SilentlyContinue) {
                Disable-ScheduledTask -TaskPath "\$($task.Substring(0, $task.LastIndexOf("\")))" -TaskName ($task.Split("\")[-1]) -ErrorAction Stop
            }
        } catch {
            Write-Warning "Erro ao desativar a tarefa $task: $_"
        }
    }
}

# Desinstalar Windows Defender via PowerShell (opcional para edições do Windows com suporte)
function Uninstall-WindowsDefender {
    Write-Host "Tentando desinstalar o Windows Defender (se suportado)..." -ForegroundColor Yellow
    try {
        # Verificar se o recurso está disponível
        $feature = Get-WindowsOptionalFeature -Online -FeatureName Windows-Defender-Features
        if ($feature.State -eq "Enabled") {
            Disable-WindowsOptionalFeature -Online -FeatureName Windows-Defender-Features -NoRestart -ErrorAction Stop
            Write-Host "Windows Defender desativado com sucesso!" -ForegroundColor Green
        } else {
            Write-Host "O recurso Windows Defender já está desativado." -ForegroundColor Cyan
        }
    } catch {
        Write-Warning "Erro ao desativar o Windows Defender como recurso do sistema: $_"
    }
}

# Função principal
function Main {
    # Verificar privilégios de Administrador
    Check-Administrator

    # Aplicar desativações
    Disable-WindowsDefenderRegistry
    Disable-DefenderServices
    Disable-DefenderScheduledTasks
    Uninstall-WindowsDefender

    Write-Host "Processo concluído. Reinicie o sistema para aplicar as alterações." -ForegroundColor Cyan
}

# Executar script
Main
